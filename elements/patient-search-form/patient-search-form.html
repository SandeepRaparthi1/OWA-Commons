<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="stylesheet" type="text/css" href="/css/patientSearchWidget.css">

<dom-module id="patient-search">
   <template>
     <iron-ajax 
     id="ajax"    
    url="http://demo.openmrs.org/openmrs/ws/rest/v1/patient"  
    method="GET"  
    handle-as="json"
    on-response="handleResponse">
     </iron-ajax>
     <h2>Find Patient Record</h2>
      <form is="iron-form" method="get" id="patient-search-form" on-iron-form-submit="setajax">
        <input type="text" id="patientsearch" placeholder="Search by ID or Name" autocomplete="off" on-keyup="setajax" >
        <i id="patient-search-clear-button" class="small icon-remove-sign"></i>        
      </form>
      <div id="patient-search-results" >
        <table id="patient-search-results-table">
          <thead>
            <tr>
              <th>Identifier</th>
              <th>Name</th>
              <th>Gender</th>
              <th>Age</th>
              <th>Birthdate</th>
            </tr>
          </thead>                             
        </table>
      </div>
  </template>
</dom-module>

<script>
  Polymer ({
     is: "patient-search",    
     setajax: function () {                    
     this.$.ajax.params = {"q":this.$.patientsearch.value,"v":"default"};     
     this.$.ajax.generateRequest();
     },
     handleResponse:function(request){
       var div = document.getElementById('patient-search-results');       
        div.style.display = 'block';          
        var objarray = new Array();
        objarray = request.detail.response.results;
        var table = document.getElementById('patient-search-results-table'); 
        var rowCount = table.rows.length;
        while(--rowCount)
        {
          table.deleteRow(rowCount);
        }
        if(objarray.length == 0 )
        {
            var rowCount = table.rows.length;               
            var row = table.insertRow(rowCount);            
            row.insertCell.innerHTML = "No matching records found";
        }         
        else
        {                      
        for(j=0;j<objarray.length;j++)
          {           
            var rowCount = table.rows.length;               
            var row = table.insertRow(rowCount);            
            row.insertCell(0).innerHTML = objarray[j].display;                               
            row.insertCell(1).innerHTML = objarray[j].person.display;
            row.insertCell(2).innerHTML = objarray[j].person.gender;
            row.insertCell(3).innerHTML = objarray[j].person.age;
            row.insertCell(4).innerHTML = objarray[j].person.birthdate;            
          }
        }                
     }    
  });
</script>
