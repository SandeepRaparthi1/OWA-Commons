<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="stylesheet" type="text/css" href="/css/main.css">

<dom-module id="patient-registration-form">
    <template>  
        <h2> Register a patient </h2>
        <iron-ajax
            id="ajax1"
            method="POST" 
            url="http://localhost:8080/openmrs/ws/rest/v1/person"             
            headers='{"Content-Type": "application/json"}'        
            handle-as="json"
            on-response="handleResponse1"> 
        </iron-ajax>
        <iron-ajax 
            id="ajax2"    
            url="http://localhost:8080/openmrs/ws/rest/v1/patientidentifiertype"  
            method="GET"  
            handle-as="json"
            on-response="handleResponse2">
        </iron-ajax>
        <iron-ajax 
            id="ajax3"    
            url="http://localhost:8080/openmrs/ws/rest/v1/location"  
            method="GET"  
            handle-as="json"
            on-response="handleResponse3">
        </iron-ajax>
        <iron-ajax 
        id="ajax4"   
        method="POST" 
        url="http://localhost:8080/openmrs/ws/rest/v1/patient"             
        headers='{"Content-Type": "application/json"}'        
        handle-as="json"
        on-response="handleResponse4"
        on-error="handleError">
        </iron-ajax>    
    <form  is="iron-form" class="simple-form-ui" id="registration" >
        <ul id="formBreadcrumb" class="options">
            <li class="doing"><span id="demographics_label">Demographics</span>
                <ul>
                    <li id="nameLabel" class="question-legend focused"><i class="icon-ok"></i><span>Name</span></li>
                    <li id="genderLabel" class="question-legend"><i class="icon-ok"></i><span>Gender</span></li>
                    <li id="birthdateLabel" class="question-legend"><i class="icon-ok"></i><span >Birthdate</span></li>
                </ul>
            </li>            
            <li>
                <span id="confirmation_label">Confirm</span>
            </li>
        </ul>
        <section id="demographics" class="non-collapsible focused">
            <fieldset id="demographics-name" class="focused">
                <legend>Name</legend>
                <div>
                    <h3>What's the patient's name?</h3>
                    <p class="left">
                        <label for="fr7057-field">Given <span>(required)</span>
                        </label>
                        <input type="text" id="fr7057field" name="givenName" value="" class="required focused ui-autocomplete-input" autocomplete="off" on-keydown="checkField">
                        <span role="status" aria-live="polite" class="ui-helper-hidden-accessible">
                        </span>
                        <span id="fr393" class="field-error" style="display: none">Required</span>
                    </p>
                    <p class="left">
                        <label for="fr2890field">Middle</label>
                        <input type="text" id="fr2890field" name="middleName" value="" class="ui-autocomplete-input" autocomplete="off">
                        <span role="status" aria-live="polite" class="ui-helper-hidden-accessible"></span>
                        <span id="fr5051" class="field-error" style="display: none"></span>
                    </p>
                    <p class="left">
                        <label for="fr905field">Family Name <span>(required)</span>
                        </label>
                        <input type="text" id="fr905field" name="familyName" value="" class="required ui-autocomplete-input" autocomplete="off" on-keydown="movetogenderfield">
                        <span role="status" aria-live="polite" class="ui-helper-hidden-accessible"></span>
                        <span id="fr6684" class="field-error" style="display: none">Required</span>
                    </p>
                </div>
                <div style="display:inline-block">
                    <nobr>
                        <input id="checkbox-unknown-patient" type="checkbox">
                        <label for="checkbox-unknown-patient">Unidentified Patient</label>
                    </nobr>
                </div>
                <input type="hidden" name="preferred" value="true">
            </fieldset>
            <fieldset id="demographics-gender">
                <legend id="genderLabel">Gender</legend>
                <h3>What's the patient's gender?</h3>
                <p id="gender">
                    <label for="genderfield">
                        <span>(required)</span>
                    </label>
                    <select id="genderfield" name="gender" class="required" on-keydown="movetobirthdatefield"size="2" data-bind=",value: gender">
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                    <span id="fr4195" class="field-error" style="display: none"></span>
                </p>
                <input id="demographics-unknown" type="hidden" name="unknown" value="false">
            </fieldset>
            <fieldset id="demographics-birthdate" class="multiple-input-date date-required no-future-date">
                <legend id="birthdateLabel">Birthdate</legend>
                <h3>What's the patient's birth date?</h3>
                <p id="fr6003">
                    <span id="fr433" class="field-error" style="display: none"></span>
                </p>
                <p class="left">
                    <label for="birthdateDay-field">Day</label>
                    <input type="text" id="birthdateDay-field" name="birthdateDay" value="" class="day number numeric-range date-component" size="5" maxlength="2" min="1" max="31">
                    <span id="fr4628" class="field-error" style="display: none"></span>
                </p>             
                <p id="birthdateMonth" class="left">
                    <label for="birthdateMonth-field">Month</label>  
                    <select id="birthdateMonth-field" name="birthdateMonth" class="month date-component">     
                        <option value="">Select</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <span id="fr6483" class="field-error" style="display: none"></span>
                </p>
                <p class="left">
                    <label for="birthdateYear-field">Year</label>
                    <input type="text" id="birthdateYearfield" name="birthdateYear" value="" class="year number numeric-range date-component" on-keydown="movetoconfirmfield" size="5" maxlength="4" min="1895" max="2015">
                    <span id="fr5519" class="field-error" style="display: none"></span>
                </p>
                <div class="clear">
                <p></p>
                <p>&nbsp;</p>
                <h3>Or</h3>
                <p>
                </p><p class="left">
                <label for="birthdateYears-field">Estimated Years</label>
                <input type="text" id="birthdateYears-field" name="birthdateYears" value="" class="years number numeric-range date-component" maxlength="3" min="0" max="120">
                <span id="fr8972" class="field-error" style="display: none"></span>
                <span class="append-to-value hidden"> year(s)</span>
                </p>
                <p class="left">
                <label for="birthdateMonths-field">Estimated Months</label>
                <input type="text" id="birthdateMonths-field" name="birthdateMonths" value="" class="months number numeric-range date-component" maxlength="2" min="0" max="11">
                <span id="fr4751" class="field-error" style="display: none"></span>
                <span class="append-to-value hidden"> month(s)</span>
                </p>
                <p></p>
                <input id="birthdate-value" type="hidden" name="birthdate">
                </div>
            </fieldset>
        </section>
        <div id="confirmation">
            <div class="before-dataCanvas"></div>
            <div id="dataCanvas">
            	<ul>
                    <li><span id="name" class="label">Name:</span><strong><span id="patientname">{{name}}</span></strong></li>
                    <li><span  class="label">Gender:</span><strong><span id="gender">{{gender}}</span></strong></li>
                    <li><span id="birthdate" class="label">Birthdate:</span><strong><span id="birthdate">{{day}}</span>
                    <span>{{month}}</span><span>{{year}}</span></strong></li>
                </ul>   	
            </div>
            <div class="after-data-canvas"></div>
            <div id="confirmationQuestion" class="focused">
                Confirm submission?
                <p style="display: inline">
                    <input id="submit" type="button" class="submitButton confirm right focused" value="Confirm" on-click="makeajax">
                </p>
                <p style="display: inline">
                    <input id="cancelSubmission" class="cancel" type="button" value="Cancel">
                </p>
            </div>
        </div>
    </form>
    </template>
</dom-module>

<script>
  var personuuid;
  var patientidentifieruuid;
  Polymer ({
     is: "patient-registration-form", 
     checkField:function(event)
     { 
        if(event.keyCode == 9 || event.keyCode == 13 )
        {
            if(this.$.fr7057field.value == "" )
            {
                document.getElementById('fr393').style.display= 'block';
                document.getElementById('fr7057field').setAttribute("class", "required ui-autocomplete-input focused error");
            }
            else 
            {
                document.getElementById('fr2890field').setAttribute("class", "ui-autocomplete-input focused");
            }
        }
     },            
     makeajax:function()
        {                      
           this.$.ajax1.body = '{"gender":"'+this.$.genderfield.value+'", "names": [{"givenName":"'+this.$.fr7057field.value+'", "familyName":"'+this.$.fr905field.value+'"}]}';             
           this.$.ajax1.generateRequest();                 
        },             
     handleResponse1:function(request)
     {        
        this.$.ajax2.generateRequest();
        this.$.ajax3.generateRequest();
        personuuid = request.detail.response.uuid;
     },
     handleResponse2:function(request)
     {                
        patientidentifieruuid = request.detail.response.results[0].uuid;
     },
     handleResponse3:function(request)
     {        
        var locuuid = request.detail.response.results[0].uuid;    
        console.log(locuuid);
        console.log(personuuid);  
        console.log(patientidentifieruuid);  
        this.$.ajax4.body = '{"person": "'+personuuid+'", "identifiers": [{"identifier":"1234-4", "identifierType":"'+patientidentifieruuid+'", "location":"'+locuuid+'", "preferred":true}]}';    
        this.$.ajax4.generateRequest();
     },
     handleResponse4:function(request)
     {
        console.log(request.detail.response);
        console.log('patient has been registred');
     },
     handleError:function(request)
     {
     	console.log(request.detail.error);
     },
     movetogenderfield:function(event)
     {        
        if(event.keyCode == 9 || event.keyCode ==13 )
        {            
        document.getElementById('demographics-name').setAttribute("class", "");
        document.getElementById('demographics-gender').setAttribute("class", "focused");        
        document.getElementById('nameLabel').setAttribute("class", "question-legend done");
        document.getElementById('genderLabel').setAttribute("class", "question-legend focused");     
        }             
     },
     movetobirthdatefield:function()
     {
        if(event.keyCode == 9)
        {  
     	document.getElementById('demographics-gender').setAttribute("class", "");
        document.getElementById('demographics-birthdate').setAttribute("class", "focused");        
        document.getElementById('genderLabel').setAttribute("class", "question-legend done");
        document.getElementById('birthdateLabel').setAttribute("class", "question-legend focused");
        }
     },
     movetoconfirmfield:function()
     {
        if(event.keyCode == 9)
        {
     	document.getElementById('demographics-birthdate').setAttribute("class", "");
        document.getElementById('confirmation').setAttribute("class", "focused");        
        document.getElementById('birthdateLabel').setAttribute("class", "question-legend done");
        document.getElementById('confirmation_label').setAttribute("class", "question-legend focused");
        this.$.gender.textContent=this.$.genderfield.value;
        this.$.patientname.textContent=this.$.fr7057field.value+this.$.fr905field.value;
        this.$.birthdate.textContent=this.$.birthdateYearfield.value;
        }
     }
  });
</script>
